<!DOCTYPE html>
<html lang="zh-CN" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${title} + ' - 钉钉告警系统'">查询任务 - 钉钉告警系统</title>
    <link href="/css/bootstrap.min.css" rel="stylesheet">
    <link href="/css/bootstrap-icons.css" rel="stylesheet">
    <style>
        .sidebar {
            min-height: 100vh;
            background-color: #f8f9fa;
        }
        .nav-link {
            color: #495057;
        }
        .nav-link:hover {
            color: #007bff;
        }
        .nav-link.active {
            background-color: #007bff;
            color: white;
        }
        .content {
            padding: 20px;
        }
        .card {
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
            border: 1px solid rgba(0, 0, 0, 0.125);
        }
        .btn-group-sm > .btn {
            padding: 0.25rem 0.5rem;
            font-size: 0.875rem;
        }
        .table th {
            background-color: #f8f9fa;
            border-top: none;
        }
        .status-running {
            color: #28a745;
            font-weight: bold;
        }
        .status-stopped {
            color: #dc3545;
            font-weight: bold;
        }
        .status-paused {
            color: #ffc107;
            font-weight: bold;
        }
        
        /* 新增：禁用按钮样式 */
        .btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }
        .cron-expression {
            font-family: 'Courier New', monospace;
            background-color: #f8f9fa;
            padding: 2px 4px;
            border-radius: 3px;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- 侧边栏 -->
            <nav class="col-md-3 col-lg-2 d-md-block sidebar collapse">
                <div class="position-sticky pt-3">
                    <h5 class="px-3 mb-3 text-muted">钉钉告警系统</h5>
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link" href="/">
                                <i class="bi bi-house-door"></i>
                                首页
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/database">
                                <i class="bi bi-server"></i>
                                数据库配置
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/template">
                                <i class="bi bi-file-text"></i>
                                告警模板
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link active" href="/task">
                                <i class="bi bi-clock"></i>
                                查询任务
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/record">
                                <i class="bi bi-list-ul"></i>
                                执行记录
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/dingtalk">
                                <i class="bi bi-chat-dots"></i>
                                钉钉配置
                            </a>
                        </li>
                    </ul>
                </div>
            </nav>

            <!-- 主内容区域 -->
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">查询任务管理</h1>
                    <div class="btn-toolbar mb-2 mb-md-0">
                        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#taskModal">
                            <i class="bi bi-plus-circle"></i>
                            新增任务
                        </button>
                    </div>
                </div>

                <!-- 搜索栏 -->
                <div class="row mb-3">
                    <div class="col-md-3">
                        <div class="input-group">
                            <input type="text" class="form-control" id="searchInput" placeholder="搜索任务名称...">
                        </div>
                    </div>
                    <div class="col-md-2">
                        <select class="form-select" id="statusFilter">
                            <option value="">全部状态</option>
                            <option value="running">运行中</option>
                            <option value="stopped">已停止</option>
                            <option value="paused">已暂停</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <select class="form-select" id="databaseFilter">
                            <option value="">全部数据库</option>
                            <!-- 数据库选项将通过JavaScript动态加载 -->
                        </select>
                    </div>
                    <div class="col-md-4">
                        <button class="btn btn-primary" type="button" onclick="filterTasks()">
                            <i class="bi bi-search"></i> 搜索
                        </button>
                        <button class="btn btn-outline-secondary ms-2" type="button" onclick="resetFilters()">
                            <i class="bi bi-arrow-clockwise"></i> 重置
                        </button>
                    </div>
                </div>

                <!-- 任务列表 -->
                <div class="card">
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>任务名称</th>
                                        <th>数据库</th>
                                        <th>Cron表达式</th>
                                        <th>状态</th>
                                        <th>下次执行时间</th>
                                        <th>创建时间</th>
                                        <th>操作</th>
                                    </tr>
                                </thead>
                                <tbody id="taskTableBody">
                                    <!-- 数据将通过JavaScript动态加载 -->
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- 分页 -->
                        <nav aria-label="分页导航">
                            <ul class="pagination justify-content-center" id="pagination">
                                <!-- 分页按钮将通过JavaScript动态生成 -->
                            </ul>
                        </nav>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- 任务编辑模态框 -->
    <div class="modal fade" id="taskModal" tabindex="-1" aria-labelledby="taskModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="taskModalLabel">新增查询任务</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="taskForm">
                        <input type="hidden" id="taskId">
                        
                        <!-- 基本信息 -->
                        <div class="card mb-3">
                            <div class="card-header">
                                <h6 class="mb-0">基本信息</h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="taskName" class="form-label">任务名称 <span class="text-danger">*</span></label>
                                            <input type="text" class="form-control" id="taskName" required>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="databaseId" class="form-label">数据库配置 <span class="text-danger">*</span></label>
                                            <select class="form-select" id="databaseId" required>
                                                <option value="">请选择数据库配置</option>
                                                <!-- 数据库选项将通过JavaScript动态加载 -->
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label for="sqlQuery" class="form-label">SQL查询语句 <span class="text-danger">*</span></label>
                                    <textarea class="form-control" id="sqlQuery" rows="6" required placeholder="请输入SQL查询语句"></textarea>
                                    <div class="form-text">支持参数化查询，使用 #{参数名} 的形式</div>
                                </div>
                                
                                <!-- SQL结果模式选择 -->
                                <div class="mb-3">
                                    <label class="form-label">SQL结果模式 <span class="text-danger">*</span></label>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="form-check">
                                                <input class="form-check-input" type="radio" name="resultMode" id="singleRowMode" value="single_row" checked onchange="toggleResultMode()">
                                                <label class="form-check-label" for="singleRowMode">
                                                    <strong>单行结果模式</strong>
                                                </label>
                                                <div class="form-text">SQL查询结果只有一行，各字段别名对应钉钉模板变量</div>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="form-check">
                                                <input class="form-check-input" type="radio" name="resultMode" id="multiRowMode" value="multi_row" onchange="toggleResultMode()">
                                                <label class="form-check-label" for="multiRowMode">
                                                    <strong>多行结果模式</strong>
                                                </label>
                                                <div class="form-text">SQL查询结果有多行，统一输出到指定的模板字段中</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- 多行模式配置 -->
                <div id="multiRowConfig" class="mb-3" style="display: none;">
                    <div class="row">
                        <div class="col-md-6">
                            <label for="targetField" class="form-label">目标字段名 <span class="text-danger">*</span></label>
                            <select class="form-select" id="targetField" onchange="updateTargetFieldDescription()">
                                <option value="">请选择目标字段名</option>
                                <option value="table_data">table_data（表格格式）</option>
                                <option value="list_data">list_data（列表格式）</option>
                                <option value="json_data">json_data（JSON格式）</option>
                            </select>
                            <div class="form-text" id="targetFieldDescription">多行结果将输出到模板中的这个字段变量</div>
                        </div>
                        <div class="col-md-6">
                            <label for="resultFormat" class="form-label">结果格式</label>
                            <select class="form-select" id="resultFormat" onchange="syncTargetField()">
                                <option value="table">表格格式</option>
                                <option value="list">列表格式</option>
                                <option value="json">JSON格式</option>
                            </select>
                        </div>
                    </div>
                </div>
                                
                                <div class="mb-0">
                                    <label for="taskDescription" class="form-label">任务描述</label>
                                    <textarea class="form-control" id="taskDescription" rows="3" placeholder="任务描述"></textarea>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 告警模板配置 -->
                        <div class="card mb-3">
                            <div class="card-header">
                                <h6 class="mb-0">告警模板配置</h6>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label class="form-label">模板选择方式 <span class="text-danger">*</span></label>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="form-check">
                                                <input class="form-check-input" type="radio" name="templateMode" id="existingTemplate" value="existing" checked onchange="toggleTemplateMode()">
                                                <label class="form-check-label" for="existingTemplate">
                                                    <strong>使用现有模板</strong>
                                                </label>
                                                <div class="form-text">从告警模板列表中选择</div>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="form-check">
                                                <input class="form-check-input" type="radio" name="templateMode" id="customTemplate" value="custom" onchange="toggleTemplateMode()">
                                                <label class="form-check-label" for="customTemplate">
                                                    <strong>自定义模板</strong>
                                                </label>
                                                <div class="form-text">在当前页面自由编写</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- 现有模板选择 -->
                                 <div id="existingTemplateConfig" class="mb-3">
                                     <label for="templateId" class="form-label">选择告警模板 <span class="text-danger">*</span></label>
                                     <select class="form-select" id="templateId" onchange="loadTemplateContent()">
                                         <option value="">请选择告警模板</option>
                                         <!-- 模板选项将通过JavaScript动态加载 -->
                                     </select>
                                 </div>
                                 
                                 <!-- 自定义模板编辑器 -->
                                 <div id="customTemplateConfig" class="mb-3" style="display: none;">
                                     <div class="mb-3">
                                         <label for="customTemplateName" class="form-label">模板名称 <span class="text-danger">*</span></label>
                                         <input type="text" class="form-control" id="customTemplateName" placeholder="请输入模板名称">
                                     </div>
                                     <div class="mb-3">
                                         <label for="customTemplateType" class="form-label">模板类型</label>
                                         <select class="form-select" id="customTemplateType" onchange="updateCustomTemplatePreview()">
                                             <option value="text">文本消息</option>
                                             <option value="markdown">Markdown消息</option>
                                             <option value="custom">自定义模板</option>
                                         </select>
                                     </div>
                                     <div class="mb-3">
                                         <label for="customTemplateContent" class="form-label">模板内容 <span class="text-danger">*</span></label>
                                         <textarea class="form-control" id="customTemplateContent" rows="8" placeholder="请输入模板内容，支持变量：${变量名}" oninput="updateCustomTemplatePreview()"></textarea>
                                         <div class="form-text">
                                             支持变量替换，使用 ${变量名} 的形式<br>
                                             <strong>系统变量：</strong><br>
                                             - ${notify_time} - 通知时间（年月日时分秒）<br>
                                             - ${execute_duration} - SQL执行耗时（毫秒）<br>
                                             - ${execute_result} - 执行结果（成功/失败）<br>
                                             - ${task_name} - 任务名称<br>
                                             - ${total_rows} - 结果行数<br>
                                             - ${current_time} - 当前时间<br>
                                             - ${execution_id} - 执行ID（唯一标识）<br>
                                             - ${task_id} - 任务ID<br>
                                             <strong>数据变量：</strong>根据SQL查询结果的字段名
                                         </div>
                                     </div>
                                     <div class="mb-3">
                                         <label class="form-label">模板预览</label>
                                         <div class="border rounded p-3 bg-light" id="customTemplatePreview" style="min-height: 100px;">
                                             选择模板类型并输入内容后，这里将显示预览效果
                                         </div>
                                     </div>
                                 </div>
                             </div>
                         </div>
                         
                         <!-- 钉钉配置 -->
                         <div class="card mb-3">
                             <div class="card-header">
                                 <h6 class="mb-0">钉钉配置</h6>
                             </div>
                             <div class="card-body">
                                 <div class="mb-3">
                                     <label class="form-label">配置选择方式 <span class="text-danger">*</span></label>
                                     <div class="row">
                                         <div class="col-md-6">
                                             <div class="form-check">
                                                 <input class="form-check-input" type="radio" name="dingtalkMode" id="existingDingtalk" value="existing" checked onchange="toggleDingtalkMode()">
                                                 <label class="form-check-label" for="existingDingtalk">
                                                     <strong>使用现有配置</strong>
                                                 </label>
                                                 <div class="form-text">从钉钉配置列表中选择</div>
                                             </div>
                                         </div>
                                         <div class="col-md-6">
                                             <div class="form-check">
                                                 <input class="form-check-input" type="radio" name="dingtalkMode" id="customDingtalk" value="custom" onchange="toggleDingtalkMode()">
                                                 <label class="form-check-label" for="customDingtalk">
                                                     <strong>自定义配置</strong>
                                                 </label>
                                                 <div class="form-text">在当前页面自由配置</div>
                                             </div>
                                         </div>
                                     </div>
                                 </div>
                                 
                                 <!-- 现有配置选择 -->
                                 <div id="existingDingtalkConfig" class="row">
                                     <div class="col-md-6">
                                         <div class="mb-3">
                                             <label for="dingtalkConfigId" class="form-label">钉钉机器人配置 <span class="text-danger">*</span></label>
                                             <select class="form-select" id="dingtalkConfigId" required onchange="loadDingtalkConfig()">
                                                 <option value="">请选择钉钉配置</option>
                                                 <!-- 钉钉配置选项将通过JavaScript动态加载 -->
                                             </select>
                                             <div class="form-text">选择已配置的钉钉机器人，包含Webhook URL和密钥</div>
                                         </div>
                                     </div>
                                     <div class="col-md-6">
                                         <div class="mb-3">
                                             <label class="form-label">@人员配置</label>
                                             <div class="row">
                                                 <div class="col-md-6">
                                                     <div class="form-check">
                                                         <input class="form-check-input" type="radio" name="atMode" id="atAllMode" value="all" checked onchange="toggleAtMode()">
                                                         <label class="form-check-label" for="atAllMode">
                                                             @所有人
                                                         </label>
                                                     </div>
                                                 </div>
                                                 <div class="col-md-6">
                                                     <div class="form-check">
                                                         <input class="form-check-input" type="radio" name="atMode" id="atSpecificMode" value="specific" onchange="toggleAtMode()">
                                                         <label class="form-check-label" for="atSpecificMode">
                                                             @指定人员
                                                         </label>
                                                     </div>
                                                 </div>
                                             </div>
                                         </div>
                                     </div>
                                 </div>
                                 
                                 <!-- 自定义配置编辑器 -->
                                 <div id="customDingtalkConfig" class="mb-3" style="display: none;">
                                     <div class="row">
                                         <div class="col-md-6">
                                             <div class="mb-3">
                                                 <label for="customWebhookUrl" class="form-label">Webhook URL <span class="text-danger">*</span></label>
                                                 <input type="url" class="form-control" id="customWebhookUrl" placeholder="https://oapi.dingtalk.com/robot/send?access_token=...">
                                                 <div class="form-text">钉钉机器人的Webhook地址</div>
                                             </div>
                                         </div>
                                         <div class="col-md-6">
                                             <div class="mb-3">
                                                 <label for="customSecret" class="form-label">密钥</label>
                                                 <input type="text" class="form-control" id="customSecret" placeholder="SEC...">
                                                 <div class="form-text">钉钉机器人的加签密钥（可选）</div>
                                             </div>
                                         </div>
                                     </div>
                                 </div>
                                 
                                 <div class="mb-0" id="atMobilesDiv" style="display: none;">
                                     <label for="atMobiles" class="form-label">指定人员手机号 <span class="text-danger">*</span></label>
                                     <input type="text" class="form-control" id="atMobiles" placeholder="多个手机号用逗号分隔，如：13800138000,13900139000">
                                     <div class="form-text">输入要@的人员手机号，多个手机号用逗号分隔</div>
                                 </div>
                             </div>
                         </div>
                         
                         <!-- 执行配置 -->
                         <div class="card mb-3">
                             <div class="card-header">
                                 <h6 class="mb-0">执行配置</h6>
                             </div>
                             <div class="card-body">
                                 <div class="row">
                                     <div class="col-md-12">
                                         <div class="mb-3">
                                             <label for="cronExpression" class="form-label">定时器表达式 <span class="text-danger">*</span></label>
                                             <input type="text" class="form-control" id="cronExpression" required placeholder="0 0 * * * ?">
                                             <div class="form-text">
                                                 格式：秒 分 时 日 月 周年<br>
                                                 示例：0 0 * * * ? (每小时执行一次)
                                             </div>
                                         </div>
                                     </div>
                                 </div>
                                 <div class="row">
                                     <div class="col-md-12">
                                         <div class="mb-3">
                                             <label for="alertCondition" class="form-label">告警条件</label>
                                             <select class="form-select" id="alertCondition" onchange="toggleAlertOptions()">
                                                 <option value="">无条件告警</option>
                                                 <option value="gt">值 > 阈值</option>
                                                 <option value="gte">值 >= 阈值</option>
                                                 <option value="lt">值 < 阈值</option>
                                                 <option value="lte">值 <= 阈值</option>
                                                 <option value="eq">值 = 阈值</option>
                                                 <option value="ne">值 != 阈值</option>
                                             </select>
                                         </div>
                                     </div>
                                 </div>
                                 <div id="alertOptionsContainer" style="display: none;">
                                     <div class="row">
                                         <div class="col-md-12">
                                             <div class="mb-3">
                                                 <label class="form-label">阈值匹配方式</label>
                                                 <div class="row">
                                                     <div class="col-md-6">
                                                         <div class="form-check">
                                                             <input class="form-check-input" type="radio" name="thresholdMode" id="rowCountMode" value="rowCount" checked onchange="toggleThresholdMode()">
                                                             <label class="form-check-label" for="rowCountMode">
                                                                 <strong>按结果行数匹配</strong>
                                                             </label>
                                                             <div class="form-text">根据SQL查询返回的记录数量进行匹配</div>
                                                         </div>
                                                     </div>
                                                     <div class="col-md-6">
                                                         <div class="form-check">
                                                             <input class="form-check-input" type="radio" name="thresholdMode" id="fieldValueMode" value="fieldValue" onchange="toggleThresholdMode()">
                                                             <label class="form-check-label" for="fieldValueMode">
                                                                 <strong>按字段值匹配</strong>
                                                             </label>
                                                             <div class="form-text">根据SQL查询结果中指定字段的值进行匹配（仅当结果为1行时生效）</div>
                                                         </div>
                                                     </div>
                                                 </div>
                                             </div>
                                         </div>
                                     </div>
                                     <div class="row">
                                         <div class="col-md-6">
                                             <div class="mb-3">
                                                 <label for="threshold" class="form-label">阈值</label>
                                                 <input type="number" class="form-control" id="threshold" placeholder="0">
                                             </div>
                                         </div>
                                         <div class="col-md-6">
                                             <div class="mb-3" id="thresholdFieldDiv" style="display: none;">
                                                 <label for="thresholdField" class="form-label">字段名 <span class="text-danger">*</span></label>
                                                 <input type="text" class="form-control" id="thresholdField" placeholder="请输入字段名或别名">
                                                 <div class="form-text">输入SQL查询结果中要比较的字段名或别名</div>
                                             </div>
                                         </div>
                                     </div>
                                 </div>
                                 <div class="row">
                                     <div class="col-md-6">
                                         <div class="form-check">
                                             <input class="form-check-input" type="checkbox" id="autoStart">
                                             <label class="form-check-label" for="autoStart">
                                                 自动启动
                                             </label>
                                         </div>
                                     </div>
                                 </div>
                             </div>
                         </div>

                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-success" onclick="testSend()">测试发送</button>
                    <button type="button" class="btn btn-primary" onclick="saveTask()">保存</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 查询结果模态框 -->
    <div class="modal fade" id="queryResultModal" tabindex="-1" aria-labelledby="queryResultModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="queryResultModalLabel">查询结果</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="queryResultContent">
                        <!-- 查询结果将在这里显示 -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                </div>
            </div>
        </div>
    </div>

    <script src="/js/bootstrap.bundle.min.js"></script>
    <script src="/js/pagination.js"></script>
    <script>
        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 初始化分页组件
            window.paginationInstance = new PaginationComponent({
                pageSize: 20,
                paginationElementId: 'pagination',
                loadDataCallback: loadTasks
            });
            
            loadTasks(1);
            loadDatabases();
            loadTemplates();
            loadDingtalkConfigs();
        });

        // 加载任务列表
        function loadTasks(page = 1) {
            const params = new URLSearchParams({
                current: page,
                size: 20 // 统一设置为20
            });

            // 添加筛选参数
            const searchKeyword = document.getElementById('searchInput')?.value;
            const statusFilter = document.getElementById('statusFilter')?.value;

            if (searchKeyword) params.append('keyword', searchKeyword);
            if (statusFilter) params.append('status', statusFilter);

            fetch(`/api/task/list?${params.toString()}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        renderTaskTable(data.data.records);
                        window.paginationInstance.renderPagination(data.data.current, data.data.pages, data.data.total);
                    } else {
                        console.error('加载任务失败:', data.message);
                    }
                })
                .catch(error => {
                    console.error('请求失败:', error);
                });
        }

        // 加载数据库配置
        function loadDatabases() {
            fetch('/api/database/list')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const databaseSelect = document.getElementById('databaseId');
                        const databaseFilter = document.getElementById('databaseFilter');
                        
                        data.data.records.forEach(db => {
                            const option = document.createElement('option');
                            option.value = db.id;
                            option.textContent = db.configName;
                            databaseSelect.appendChild(option.cloneNode(true));
                            databaseFilter.appendChild(option);
                        });
                    }
                })
                .catch(error => console.error('Error loading databases:', error));
        }

        // 加载告警模板
        function loadTemplates() {
            fetch('/api/template/list?current=1&size=100')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const templateSelect = document.getElementById('templateId');
                        data.data.records.forEach(template => {
                            if (template.enabled) { // 只显示启用的模板
                                const option = document.createElement('option');
                                option.value = template.id;
                                option.textContent = template.templateName;
                                templateSelect.appendChild(option);
                            }
                        });
                    }
                })
                .catch(error => console.error('Error loading templates:', error));
        }

        // 加载钉钉配置
        function loadDingtalkConfigs() {
            fetch('/api/dingtalk/list?current=1&size=100')
                .then(response => response.json())
                .then(data => {
                    console.log('Dingtalk configs response:', data);
                    const dingtalkSelect = document.getElementById('dingtalkConfigId');
                    
                    // 清空现有选项，保留默认选项
                    dingtalkSelect.innerHTML = '<option value="">请选择钉钉配置</option>';
                    
                    if (data.success && data.data && data.data.records) {
                        let enabledCount = 0;
                        data.data.records.forEach(config => {
                            if (config.enabled) { // 只显示启用的配置
                                const option = document.createElement('option');
                                option.value = config.id;
                                option.textContent = config.name; // 修正字段名
                                dingtalkSelect.appendChild(option);
                                enabledCount++;
                            }
                        });
                        console.log(`Loaded ${enabledCount} enabled dingtalk configs`);
                        
                        if (enabledCount === 0) {
                            console.warn('No enabled dingtalk configs found');
                        }
                    } else {
                        console.error('Failed to load dingtalk configs:', data.message || 'Unknown error');
                    }
                })
                .catch(error => {
                    console.error('Error loading dingtalk configs:', error);
                    const dingtalkSelect = document.getElementById('dingtalkConfigId');
                    dingtalkSelect.innerHTML = '<option value="">加载失败，请刷新重试</option>';
                });
        }

        // 渲染任务表格
        function renderTaskTable(tasks) {
            const tbody = document.getElementById('taskTableBody');
            tbody.innerHTML = '';

            tasks.forEach(task => {
                const row = document.createElement('tr');
                // 判断任务是否正在运行（NORMAL状态表示正在运行）
                const isRunning = task.status === 'NORMAL';
                
                row.innerHTML = `
                    <td>${task.id}</td>
                    <td>${task.taskName}</td>
                    <td>${task.databaseConfigName || '-'}</td>
                    <td><code class="cron-expression">${task.cronExpression}</code></td>
                    <td><span class="status-${task.status}">${getStatusText(task.status)}</span></td>
                    <td>${formatDateTime(task.nextExecuteTime)}</td>
                    <td>${formatDateTime(task.createTime)}</td>
                    <td>
                        <div class="btn-group btn-group-sm" role="group">
                            <!-- 启动按钮 -->
                            ${isRunning ? 
                                `<button type="button" class="btn btn-outline-success" disabled>
                                    <i class="bi bi-play"></i> 启动
                                </button>` :
                                `<button type="button" class="btn btn-outline-success" onclick="startTask(${task.id})">
                                    <i class="bi bi-play"></i> 启动
                                </button>`
                            }
                            
                            <!-- 停止按钮 -->
                            ${isRunning ? 
                                `<button type="button" class="btn btn-outline-danger" onclick="stopTask(${task.id})">
                                    <i class="bi bi-stop"></i> 停止
                                </button>` :
                                `<button type="button" class="btn btn-outline-danger" disabled>
                                    <i class="bi bi-stop"></i> 停止
                                </button>`
                            }
                            
                            <button type="button" class="btn btn-outline-primary" onclick="editTask(${task.id})">
                                <i class="bi bi-pencil"></i> 编辑
                            </button>
                            <button type="button" class="btn btn-outline-info" onclick="executeTask(${task.id})">
                                <i class="bi bi-play-circle"></i> 执行
                            </button>
                            <button type="button" class="btn btn-outline-danger" onclick="deleteTask(${task.id})">
                                <i class="bi bi-trash"></i> 删除
                            </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }



        // 获取状态文本
        function getStatusText(status) {
            switch(status) {
                case 'NORMAL': return '运行中';
                case 'PAUSED': return '已暂停';
                case 'NOT_SCHEDULED': return '已停止';
                case 'ERROR': return '错误';
                case 'BLOCKED': return '阻塞';
                case 'COMPLETE': return '完成';
                default: return '未知';
            }
        }

        // 格式化日期时间
        function formatDateTime(dateTime) {
            if (!dateTime) return '-';
            return new Date(dateTime).toLocaleString('zh-CN');
        }

        // 切换结果模式
        function toggleResultMode() {
            const singleMode = document.getElementById('singleRowMode').checked;
            const multiRowConfig = document.getElementById('multiRowConfig');
            
            if (singleMode) {
                multiRowConfig.style.display = 'none';
            } else {
                multiRowConfig.style.display = 'block';
            }
        }
        
        // 切换告警模板选择方式
        function toggleTemplateMode() {
            const mode = document.querySelector('input[name="templateMode"]:checked').value;
            const existingTemplateDiv = document.getElementById('existingTemplateConfig');
            const customTemplateDiv = document.getElementById('customTemplateConfig');
            
            if (mode === 'existing') {
                existingTemplateDiv.style.display = 'block';
                customTemplateDiv.style.display = 'none';
            } else {
                existingTemplateDiv.style.display = 'none';
                customTemplateDiv.style.display = 'block';
                updateCustomTemplatePreview();
            }
        }
        
        // 切换告警选项显示
        function toggleAlertOptions() {
            const alertCondition = document.getElementById('alertCondition').value;
            const alertOptionsContainer = document.getElementById('alertOptionsContainer');
            
            if (alertCondition === '') {
                // 无条件告警，隐藏所有阈值相关选项
                alertOptionsContainer.style.display = 'none';
            } else {
                // 有条件告警，显示阈值相关选项
                alertOptionsContainer.style.display = 'block';
                toggleThresholdMode(); // 同时更新阈值模式显示
            }
        }
        
        // 切换阈值匹配方式
        function toggleThresholdMode() {
            const mode = document.querySelector('input[name="thresholdMode"]:checked').value;
            const thresholdFieldDiv = document.getElementById('thresholdFieldDiv');
            
            if (mode === 'fieldValue') {
                thresholdFieldDiv.style.display = 'block';
            } else {
                thresholdFieldDiv.style.display = 'none';
                document.getElementById('thresholdField').value = ''; // 清空字段名
            }
        }
        
        // 切换@人员模式
        function toggleAtMode() {
            const mode = document.querySelector('input[name="atMode"]:checked').value;
            const atMobilesDiv = document.getElementById('atMobilesDiv');
            
            if (mode === 'specific') {
                atMobilesDiv.style.display = 'block';
            } else {
                atMobilesDiv.style.display = 'none';
                document.getElementById('atMobiles').value = ''; // 清空手机号
            }
        }
        
        // 切换钉钉配置选择方式
        function toggleDingtalkMode() {
            const mode = document.querySelector('input[name="dingtalkMode"]:checked').value;
            const existingDingtalkDiv = document.getElementById('existingDingtalkConfig');
            const customDingtalkDiv = document.getElementById('customDingtalkConfig');
            
            if (mode === 'existing') {
                existingDingtalkDiv.style.display = 'block';
                customDingtalkDiv.style.display = 'none';
            } else {
                existingDingtalkDiv.style.display = 'none';
                customDingtalkDiv.style.display = 'block';
            }
        }
        
        // 加载钉钉配置内容
        function loadDingtalkConfig() {
            const dingtalkId = document.getElementById('dingtalkConfigId').value;
            if (!dingtalkId) {
                return;
            }
            
            fetch(`/api/dingtalk/${dingtalkId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const config = data.data;
                        // 这里可以显示选中的钉钉配置信息
                        console.log('Selected dingtalk config:', config);
                    }
                })
                .catch(error => console.error('Error loading dingtalk config:', error));
        }
        
        // 清空自定义模板编辑器
        function clearCustomTemplateEditor() {
            document.getElementById('customTemplateName').value = '';
            document.getElementById('customTemplateType').value = 'text';
            document.getElementById('customTemplateContent').value = '';
            updateCustomTemplatePreview();
        }
        
        // 更新自定义模板预览
        function updateCustomTemplatePreview() {
            const templateType = document.getElementById('customTemplateType').value;
            const templateContent = document.getElementById('customTemplateContent').value;
            const preview = document.getElementById('customTemplatePreview');
            
            if (!templateContent) {
                preview.innerHTML = '选择模板类型并输入内容后，这里将显示预览效果';
                return;
            }
            
            // 模拟变量替换
            let previewContent = templateContent
                .replace(/\$\{alertTime\}/g, new Date().toLocaleString('zh-CN'))
                .replace(/\$\{alertLevel\}/g, '警告')
                .replace(/\$\{alertMessage\}/g, '这是一条示例告警消息')
                .replace(/\$\{taskName\}/g, '示例任务')
                .replace(/\$\{result_data\}/g, '查询结果数据')
                .replace(/\$\{count\}/g, '100')
                .replace(/\$\{threshold\}/g, '50');
            
            if (templateType === 'markdown') {
                // 简单的Markdown渲染
                previewContent = previewContent
                    .replace(/^### (.*$)/gim, '<h5>$1</h5>')
                    .replace(/^## (.*$)/gim, '<h4>$1</h4>')
                    .replace(/^# (.*$)/gim, '<h3>$1</h3>')
                    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                    .replace(/\*(.*?)\*/g, '<em>$1</em>')
                    .replace(/\n/g, '<br>');
                preview.innerHTML = previewContent;
            } else {
                preview.innerHTML = previewContent.replace(/\n/g, '<br>');
            }
        }
        
        // 筛选任务
        function filterTasks() {
            loadTasks(1); // 筛选时总是从第一页开始
        }

        // 重置筛选条件
        function resetFilters() {
            document.getElementById('searchInput').value = '';
            document.getElementById('statusFilter').value = '';
            document.getElementById('databaseFilter').value = '';
            loadTasks(1);
        }

        // 启动任务
        function startTask(id) {
            fetch(`/api/task/${id}/start`, {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                        alert('任务启动成功');
                        loadTasks(window.paginationInstance.currentPage);
                    } else {
                    alert('任务启动失败：' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('任务启动失败');
            });
        }

        // 暂停任务
        function pauseTask(id) {
            if (confirm('确定要暂停这个任务吗？')) {
                fetch(`/api/task/${id}/pause`, {
                    method: 'POST'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('任务暂停成功');
                        loadTasks(window.paginationInstance.currentPage);
                    } else {
                        alert('任务暂停失败：' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('任务暂停失败');
                });
            }
        }

        // 停止任务
        function stopTask(id) {
            if (confirm('确定要停止这个任务吗？停止后任务将从调度器中移除，需要重新启动。')) {
                fetch(`/api/task/${id}/stop`, {
                    method: 'POST'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('任务停止成功');
                        loadTasks(window.paginationInstance.currentPage);
                    } else {
                        alert('任务停止失败：' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('任务停止失败');
                });
            }
        }

        // 执行任务
        function executeTask(id) {
            if (confirm('确定要立即执行这个任务吗？')) {
                fetch(`/api/task/${id}/execute`, {
                    method: 'POST'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('任务执行成功');
                    } else {
                        alert('任务执行失败：' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('任务执行失败');
                });
            }
        }

        // 编辑任务
        function editTask(id) {
            // 先加载钉钉配置，确保选项可用
            loadDingtalkConfigs();
            
            fetch(`/api/task/${id}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const task = data.data;
                        document.getElementById('taskId').value = task.id;
                        document.getElementById('taskName').value = task.taskName;
                        document.getElementById('databaseId').value = task.databaseConfigId;
                        document.getElementById('sqlQuery').value = task.sqlContent;
                        document.getElementById('cronExpression').value = task.cronExpression;
                        document.getElementById('templateId').value = task.alertTemplateId;
                        document.getElementById('alertCondition').value = task.alertCondition || '';
                        document.getElementById('threshold').value = task.threshold || '';
                        
                        // 设置阈值匹配方式
                        const thresholdMode = task.thresholdMode || 'count';
                        // 映射数据库值到前端值
                        const frontendThresholdMode = thresholdMode === 'count' ? 'rowCount' : 'fieldValue';
                        const thresholdModeElement = document.querySelector(`input[name="thresholdMode"][value="${frontendThresholdMode}"]`);
                        if (thresholdModeElement) {
                            thresholdModeElement.checked = true;
                        }
                        document.getElementById('thresholdField').value = task.thresholdField || '';
                        toggleAlertOptions(); // 切换告警选项显示状态
                        toggleThresholdMode(); // 切换阈值模式显示状态
                        
                        // 设置结果模式
                        const resultMode = task.resultMode || 'single_row';
                        document.querySelector(`input[name="resultMode"][value="${resultMode}"]`).checked = true;
                        document.getElementById('targetField').value = task.targetField || '';
                        document.getElementById('resultFormat').value = task.resultFormat || 'table';
                        toggleResultMode(); // 切换结果模式显示状态
                        
                        // 设置告警模板模式
                        const templateMode = task.templateMode || 'existing';
                        if (templateMode === 'custom') {
                            document.getElementById('customTemplate').checked = true;
                            if (task.customTemplateData) {
                                document.getElementById('customTemplateName').value = task.customTemplateData.templateName || '';
                                document.getElementById('customTemplateType').value = task.customTemplateData.templateType || 'text';
                                document.getElementById('customTemplateContent').value = task.customTemplateData.templateContent || '';
                                
                                // 回显自定义模板的钉钉配置
                                if (task.customTemplateData.webhookUrl || task.customTemplateData.secret) {
                                    document.getElementById('customDingtalk').checked = true;
                                    document.getElementById('customWebhookUrl').value = task.customTemplateData.webhookUrl || '';
                                    document.getElementById('customSecret').value = task.customTemplateData.secret || '';
                                    
                                    // 设置@人员配置
                                    if (task.customTemplateData.atAll) {
                                        document.getElementById('atAllMode').checked = true;
                                    } else if (task.customTemplateData.atMobiles) {
                                        document.getElementById('atSpecificMode').checked = true;
                                        document.getElementById('atMobiles').value = task.customTemplateData.atMobiles;
                                    }
                                    
                                    toggleDingtalkMode(); // 切换钉钉配置显示状态
                                    toggleAtMode(); // 切换@人员配置显示状态
                                }
                            }
                        } else {
                            document.getElementById('existingTemplate').checked = true;
                            if (task.alertTemplateId) {
                                document.getElementById('templateId').value = task.alertTemplateId;
                            }
                        }
                        toggleTemplateMode(); // 切换模板模式显示状态
                        
                        // 设置钉钉配置 - 使用dingtalkMode字段
                        const dingtalkMode = task.dingtalkMode || 'existing';
                        if (dingtalkMode === 'existing') {
                            document.getElementById('existingDingtalk').checked = true;
                            if (task.dingtalkConfigId) {
                                // 延迟设置钉钉配置值，确保选项已加载
                                setTimeout(() => {
                                    const dingtalkSelect = document.getElementById('dingtalkConfigId');
                                    dingtalkSelect.value = task.dingtalkConfigId;
                                    // 如果设置失败，说明配置可能已被删除或禁用
                                    if (dingtalkSelect.value !== task.dingtalkConfigId.toString()) {
                                        console.warn('钉钉配置ID', task.dingtalkConfigId, '不存在或已禁用');
                                        alert('原钉钉配置不存在或已禁用，请重新选择钉钉配置');
                                    }
                                }, 100);
                            }
                        } else if (dingtalkMode === 'custom') {
                            document.getElementById('customDingtalk').checked = true;
                            if (task.customDingtalkData) {
                                document.getElementById('customWebhookUrl').value = task.customDingtalkData.webhookUrl || '';
                                document.getElementById('customSecret').value = task.customDingtalkData.secret || '';
                            }
                        } else {
                            document.getElementById('existingDingtalk').checked = true;
                        }
                        toggleDingtalkMode(); // 切换钉钉配置模式显示状态
                        
                        // 设置@人员配置
                        if (task.atAll) {
                            document.getElementById('atAllMode').checked = true;
                        } else {
                            document.getElementById('atSpecificMode').checked = true;
                            document.getElementById('atMobiles').value = task.atMobiles || '';
                        }
                        toggleAtMode(); // 切换@人员模式显示状态
                        
                        document.getElementById('taskDescription').value = task.remark || '';
                        document.getElementById('taskModalLabel').textContent = '编辑查询任务';
                        
                        const modal = new bootstrap.Modal(document.getElementById('taskModal'));
                        modal.show();
                    } else {
                        alert('获取任务信息失败：' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('获取任务信息失败');
                });
        }

        // 删除任务
        function deleteTask(id) {
            if (confirm('确定要删除这个任务吗？删除后将无法恢复！')) {
                fetch(`/api/task/${id}`, {
                    method: 'DELETE'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('删除成功');
                        loadTasks(window.paginationInstance.currentPage);
                    } else {
                        alert('删除失败：' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('删除失败');
                });
            }
        }

        // 测试发送
        function testSend() {
            const form = document.getElementById('taskForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            // 收集任务数据
            const taskData = {
                taskName: document.getElementById('taskName').value,
                databaseConfigId: parseInt(document.getElementById('databaseId').value),
                sqlContent: document.getElementById('sqlQuery').value,
                remark: document.getElementById('taskDescription').value,
                resultMode: document.querySelector('input[name="resultMode"]:checked').value,
                targetField: document.getElementById('targetField').value,
                resultFormat: document.getElementById('resultFormat').value,
                cronExpression: document.getElementById('cronExpression').value,
                alertCondition: document.getElementById('alertCondition').value,
                threshold: document.getElementById('threshold').value ? parseInt(document.getElementById('threshold').value) : null,
                thresholdMode: document.querySelector('input[name="thresholdMode"]:checked').value === 'rowCount' ? 'count' : 'value',
                thresholdField: document.getElementById('thresholdField').value,
                templateMode: document.querySelector('input[name="templateMode"]:checked').value
            };

            // 处理告警模板
            const templateMode = document.querySelector('input[name="templateMode"]:checked').value;
            if (templateMode === 'existing') {
                taskData.alertTemplateId = parseInt(document.getElementById('templateId').value);
            } else {
                taskData.customTemplateData = {
                    templateName: document.getElementById('customTemplateName').value,
                    templateType: document.getElementById('customTemplateType').value,
                    templateContent: document.getElementById('customTemplateContent').value
                };
            }

            // 处理钉钉配置
            const dingtalkMode = document.querySelector('input[name="dingtalkMode"]:checked').value;
            if (dingtalkMode === 'existing') {
                taskData.dingtalkConfigId = parseInt(document.getElementById('dingtalkConfigId').value);
            } else {
                taskData.customDingtalkData = {
                    webhookUrl: document.getElementById('customWebhookUrl').value,
                    secret: document.getElementById('customSecret').value
                };
            }
            
            // @人员配置（仅当不是自定义模板时）
            if (taskData.templateMode !== 'custom') {
                const atMode = document.querySelector('input[name="atMode"]:checked').value;
                if (atMode === 'all') {
                    taskData.atAll = true;
                    taskData.atMobiles = '';
                } else {
                    taskData.atAll = false;
                    taskData.atMobiles = document.getElementById('atMobiles').value;
                }
            }

            fetch('/api/task/test-send', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(taskData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('测试发送成功！请检查钉钉群消息。');
                } else {
                    alert('测试发送失败：' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('测试发送失败');
            });
        }

        // 显示查询结果
        function showQueryResult(result) {
            const content = document.getElementById('queryResultContent');
            
            if (result.length === 0) {
                content.innerHTML = '<div class="alert alert-info">查询结果为空</div>';
            } else {
                let html = '<div class="table-responsive"><table class="table table-striped table-sm">';
                
                // 表头
                html += '<thead><tr>';
                Object.keys(result[0]).forEach(key => {
                    html += `<th>${key}</th>`;
                });
                html += '</tr></thead>';
                
                // 表体
                html += '<tbody>';
                result.forEach(row => {
                    html += '<tr>';
                    Object.values(row).forEach(value => {
                        html += `<td>${value || '-'}</td>`;
                    });
                    html += '</tr>';
                });
                html += '</tbody></table></div>';
                
                html += `<div class="mt-2"><small class="text-muted">共 ${result.length} 条记录</small></div>`;
                content.innerHTML = html;
            }
            
            const modal = new bootstrap.Modal(document.getElementById('queryResultModal'));
            modal.show();
        }

        // 保存任务
        function saveTask() {
            const form = document.getElementById('taskForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            const taskData = {
                id: document.getElementById('taskId').value,
                taskName: document.getElementById('taskName').value,
                databaseConfigId: parseInt(document.getElementById('databaseId').value),
                sqlContent: document.getElementById('sqlQuery').value,
                remark: document.getElementById('taskDescription').value,
                // 新增字段
                resultMode: document.querySelector('input[name="resultMode"]:checked').value,
                targetField: document.getElementById('targetField').value,
                resultFormat: document.getElementById('resultFormat').value,
                // 执行配置
                cronExpression: document.getElementById('cronExpression').value,
                alertCondition: document.getElementById('alertCondition').value,
                threshold: document.getElementById('threshold').value ? parseInt(document.getElementById('threshold').value) : null,
                thresholdMode: document.querySelector('input[name="thresholdMode"]:checked').value === 'rowCount' ? 'count' : 'value',
                thresholdField: document.getElementById('thresholdField').value,
                autoStart: document.getElementById('autoStart').checked,
                templateMode: document.querySelector('input[name="templateMode"]:checked').value,
                dingtalkMode: document.querySelector('input[name="dingtalkMode"]:checked').value
            };

            // 处理告警模板
            const templateMode = document.querySelector('input[name="templateMode"]:checked').value;
            if (templateMode === 'existing') {
                taskData.alertTemplateId = parseInt(document.getElementById('templateId').value);
            } else {
                // 自定义模板数据
                taskData.customTemplateData = {
                    templateName: document.getElementById('customTemplateName').value,
                    templateType: document.getElementById('customTemplateType').value,
                    templateContent: document.getElementById('customTemplateContent').value
                };
                // 移除钉钉配置相关代码，不再放入customTemplateData中
            }

            // 独立处理钉钉配置（与模板配置解耦）
            const dingtalkMode = document.querySelector('input[name="dingtalkMode"]:checked').value;
            if (dingtalkMode === 'existing') {
                const dingtalkConfigSelect = document.getElementById('dingtalkConfigId');
                if (dingtalkConfigSelect && dingtalkConfigSelect.value) {
                    taskData.dingtalkConfigId = parseInt(dingtalkConfigSelect.value);
                }
                // 清除自定义配置
                taskData.customDingtalkData = null;
            } else if (dingtalkMode === 'custom') {
                // 自定义钉钉配置
                taskData.customDingtalkData = {
                    webhookUrl: document.getElementById('customWebhookUrl').value,
                    secret: document.getElementById('customSecret').value
                };
                // 清除配置ID
                taskData.dingtalkConfigId = null;
            }
            
            // @人员配置（保持不变）
            const atMode = document.querySelector('input[name="atMode"]:checked').value;
            if (atMode === 'all') {
                taskData.atAll = true;
                taskData.atMobiles = '';
            } else {
                taskData.atAll = false;
                taskData.atMobiles = document.getElementById('atMobiles').value;
            }

            const url = taskData.id ? `/api/task/${taskData.id}` : '/api/task';
            const method = taskData.id ? 'PUT' : 'POST';

            fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(taskData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('保存成功');
                    const modal = bootstrap.Modal.getInstance(document.getElementById('taskModal'));
                    modal.hide();
                    loadTasks(window.paginationInstance.currentPage);
                    resetForm();
                } else {
                    alert('保存失败：' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('保存失败');
            });
        }

        // 同步目标字段名和结果格式
        function syncTargetField() {
            const resultFormat = document.getElementById('resultFormat').value;
            const targetField = document.getElementById('targetField');
            
            switch(resultFormat) {
                case 'table':
                    targetField.value = 'table_data';
                    break;
                case 'list':
                    targetField.value = 'list_data';
                    break;
                case 'json':
                    targetField.value = 'json_data';
                    break;
            }
            updateTargetFieldDescription();
        }

        // 更新目标字段描述
        function updateTargetFieldDescription() {
            const targetField = document.getElementById('targetField').value;
            const description = document.getElementById('targetFieldDescription');
            
            switch(targetField) {
                case 'table_data':
                    description.textContent = '数据将以表格格式输出到模板变量 ${table_data} 中';
                    break;
                case 'list_data':
                    description.textContent = '数据将以列表格式输出到模板变量 ${list_data} 中';
                    break;
                case 'json_data':
                    description.textContent = '数据将以JSON格式输出到模板变量 ${json_data} 中';
                    break;
                default:
                    description.textContent = '多行结果将输出到模板中的这个字段变量';
            }
        }

        // 重置表单
        function resetForm() {
            document.getElementById('taskForm').reset();
            document.getElementById('taskId').value = '';
            document.getElementById('autoStart').checked = false;
            document.getElementById('taskModalLabel').textContent = '新增查询任务';
            
            // 重置结果模式
            document.getElementById('singleRowMode').checked = true;
            document.getElementById('multiRowConfig').style.display = 'none';
            
            // 重置告警条件和阈值匹配方式
            document.getElementById('alertCondition').value = '';
            document.getElementById('threshold').value = '';
            document.getElementById('rowCountMode').checked = true;
            document.getElementById('thresholdField').value = '';
            toggleAlertOptions();
            toggleThresholdMode();
            
            // 重置@人员配置
            document.getElementById('atAllMode').checked = true;
            document.getElementById('atMobiles').value = '';
            toggleAtMode();
            
            // 重置告警模板选择
            document.getElementById('existingTemplate').checked = true;
            document.getElementById('existingTemplateConfig').style.display = 'block';
            document.getElementById('customTemplateConfig').style.display = 'none';
            clearCustomTemplateEditor();
            
            // 重置钉钉配置选择
            document.getElementById('existingDingtalk').checked = true;
            document.getElementById('existingDingtalkConfig').style.display = 'block';
            document.getElementById('customDingtalkConfig').style.display = 'none';
            document.getElementById('customWebhookUrl').value = '';
            document.getElementById('customSecret').value = '';
        }

        // 模态框关闭时重置表单
        document.getElementById('taskModal').addEventListener('hidden.bs.modal', function () {
            resetForm();
        });
    </script>
</body>
</html>